{"ast":null,"code":"import * as XLSX from 'xlsx';\n// 将列索引转换为Excel列名 (0->A, 1->B, etc.)\nconst getColumnName = index => {\n  let result = '';\n  while (index >= 0) {\n    result = String.fromCharCode(65 + index % 26) + result;\n    index = Math.floor(index / 26) - 1;\n  }\n  return result;\n};\n\n// 解析灰阶数据：从B1开始，每隔22个单元格获取下一个值\nexport const parseGrayScaleData = worksheet => {\n  const values = [];\n  const positions = [];\n  let currentRow = 1; // 从第1行开始\n  const column = 'B'; // B列\n\n  while (true) {\n    const cellAddress = `${column}${currentRow}`;\n    const cell = worksheet[cellAddress];\n\n    // 如果单元格为空或不存在，停止解析\n    if (!cell || cell.v === undefined || cell.v === null || cell.v === '') {\n      break;\n    }\n    const value = typeof cell.v === 'number' ? cell.v : parseFloat(cell.v.toString());\n    if (!isNaN(value)) {\n      values.push(value);\n      positions.push(cellAddress);\n    }\n    currentRow += 22; // 每隔22个单元格\n  }\n  return {\n    values,\n    positions\n  };\n};\n\n// 解析亮度数据块：A2-AF21 和 A24-AF43，每隔22行插入\nexport const parseBrightnessBlocks = worksheet => {\n  const blocks = [];\n\n  // 定义数据块的范围\n  const blockConfigs = [{\n    startRow: 2,\n    endRow: 21,\n    label: 'Block 1 (A2-AF21)'\n  }, {\n    startRow: 24,\n    endRow: 43,\n    label: 'Block 2 (A24-AF43)'\n  }];\n  let blockIndex = 0;\n  let currentStartRow = blockConfigs[0].startRow;\n  while (blockIndex < blockConfigs.length) {\n    const config = blockConfigs[blockIndex];\n    const data = [];\n\n    // 解析32列 (A到AF) x 20行的数据\n    for (let row = config.startRow; row <= config.endRow; row++) {\n      const rowData = [];\n\n      // 从A列(0)到AF列(31)，共32列\n      for (let col = 0; col < 32; col++) {\n        const columnName = getColumnName(col);\n        const cellAddress = `${columnName}${row}`;\n        const cell = worksheet[cellAddress];\n        let value = 0;\n        if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {\n          value = typeof cell.v === 'number' ? cell.v : parseFloat(cell.v.toString());\n          if (isNaN(value)) value = 0;\n        }\n        rowData.push(value);\n      }\n      data.push(rowData);\n    }\n    blocks.push({\n      data,\n      startRow: config.startRow,\n      endRow: config.endRow,\n      label: config.label\n    });\n    blockIndex++;\n\n    // 如果还有更多块，计算下一个块的起始行（每隔22行）\n    if (blockIndex < blockConfigs.length) {\n      currentStartRow += 22;\n      // 更新下一个块的配置\n      if (blockIndex < blockConfigs.length) {\n        blockConfigs[blockIndex].startRow = currentStartRow;\n        blockConfigs[blockIndex].endRow = currentStartRow + 19; // 20行数据\n      }\n    }\n  }\n  return blocks;\n};\n\n// 主解析函数\nexport const parseExcelData = file => {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = e => {\n      try {\n        var _e$target;\n        const data = new Uint8Array((_e$target = e.target) === null || _e$target === void 0 ? void 0 : _e$target.result);\n        const workbook = XLSX.read(data, {\n          type: 'array'\n        });\n\n        // 获取第一个工作表\n        const sheetName = workbook.SheetNames[0];\n        const worksheet = workbook.Sheets[sheetName];\n\n        // 解析数据\n        const grayScale = parseGrayScaleData(worksheet);\n        const brightnessBlocks = parseBrightnessBlocks(worksheet);\n        resolve({\n          grayScale,\n          brightnessBlocks\n        });\n      } catch (error) {\n        reject(error);\n      }\n    };\n    reader.onerror = () => {\n      reject(new Error('文件读取失败'));\n    };\n    reader.readAsArrayBuffer(file);\n  });\n};","map":{"version":3,"names":["XLSX","getColumnName","index","result","String","fromCharCode","Math","floor","parseGrayScaleData","worksheet","values","positions","currentRow","column","cellAddress","cell","v","undefined","value","parseFloat","toString","isNaN","push","parseBrightnessBlocks","blocks","blockConfigs","startRow","endRow","label","blockIndex","currentStartRow","length","config","data","row","rowData","col","columnName","parseExcelData","file","Promise","resolve","reject","reader","FileReader","onload","e","_e$target","Uint8Array","target","workbook","read","type","sheetName","SheetNames","Sheets","grayScale","brightnessBlocks","error","onerror","Error","readAsArrayBuffer"],"sources":["D:/source/fitdata/fitdata-visualizer/src/utils/dataParser.ts"],"sourcesContent":["import * as XLSX from 'xlsx';\n\nexport interface GrayScaleData {\n  values: number[];\n  positions: string[];\n}\n\nexport interface BrightnessBlock {\n  data: number[][];\n  startRow: number;\n  endRow: number;\n  label: string;\n}\n\nexport interface ParsedData {\n  grayScale: GrayScaleData;\n  brightnessBlocks: BrightnessBlock[];\n}\n\n// 将列索引转换为Excel列名 (0->A, 1->B, etc.)\nconst getColumnName = (index: number): string => {\n  let result = '';\n  while (index >= 0) {\n    result = String.fromCharCode(65 + (index % 26)) + result;\n    index = Math.floor(index / 26) - 1;\n  }\n  return result;\n};\n\n// 解析灰阶数据：从B1开始，每隔22个单元格获取下一个值\nexport const parseGrayScaleData = (worksheet: XLSX.WorkSheet): GrayScaleData => {\n  const values: number[] = [];\n  const positions: string[] = [];\n  \n  let currentRow = 1; // 从第1行开始\n  const column = 'B'; // B列\n  \n  while (true) {\n    const cellAddress = `${column}${currentRow}`;\n    const cell = worksheet[cellAddress];\n    \n    // 如果单元格为空或不存在，停止解析\n    if (!cell || cell.v === undefined || cell.v === null || cell.v === '') {\n      break;\n    }\n    \n    const value = typeof cell.v === 'number' ? cell.v : parseFloat(cell.v.toString());\n    if (!isNaN(value)) {\n      values.push(value);\n      positions.push(cellAddress);\n    }\n    \n    currentRow += 22; // 每隔22个单元格\n  }\n  \n  return { values, positions };\n};\n\n// 解析亮度数据块：A2-AF21 和 A24-AF43，每隔22行插入\nexport const parseBrightnessBlocks = (worksheet: XLSX.WorkSheet): BrightnessBlock[] => {\n  const blocks: BrightnessBlock[] = [];\n  \n  // 定义数据块的范围\n  const blockConfigs = [\n    { startRow: 2, endRow: 21, label: 'Block 1 (A2-AF21)' },\n    { startRow: 24, endRow: 43, label: 'Block 2 (A24-AF43)' }\n  ];\n  \n  let blockIndex = 0;\n  let currentStartRow = blockConfigs[0].startRow;\n  \n  while (blockIndex < blockConfigs.length) {\n    const config = blockConfigs[blockIndex];\n    const data: number[][] = [];\n    \n    // 解析32列 (A到AF) x 20行的数据\n    for (let row = config.startRow; row <= config.endRow; row++) {\n      const rowData: number[] = [];\n      \n      // 从A列(0)到AF列(31)，共32列\n      for (let col = 0; col < 32; col++) {\n        const columnName = getColumnName(col);\n        const cellAddress = `${columnName}${row}`;\n        const cell = worksheet[cellAddress];\n        \n        let value = 0;\n        if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {\n          value = typeof cell.v === 'number' ? cell.v : parseFloat(cell.v.toString());\n          if (isNaN(value)) value = 0;\n        }\n        \n        rowData.push(value);\n      }\n      \n      data.push(rowData);\n    }\n    \n    blocks.push({\n      data,\n      startRow: config.startRow,\n      endRow: config.endRow,\n      label: config.label\n    });\n    \n    blockIndex++;\n    \n    // 如果还有更多块，计算下一个块的起始行（每隔22行）\n    if (blockIndex < blockConfigs.length) {\n      currentStartRow += 22;\n      // 更新下一个块的配置\n      if (blockIndex < blockConfigs.length) {\n        blockConfigs[blockIndex].startRow = currentStartRow;\n        blockConfigs[blockIndex].endRow = currentStartRow + 19; // 20行数据\n      }\n    }\n  }\n  \n  return blocks;\n};\n\n// 主解析函数\nexport const parseExcelData = (file: File): Promise<ParsedData> => {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    \n    reader.onload = (e) => {\n      try {\n        const data = new Uint8Array(e.target?.result as ArrayBuffer);\n        const workbook = XLSX.read(data, { type: 'array' });\n        \n        // 获取第一个工作表\n        const sheetName = workbook.SheetNames[0];\n        const worksheet = workbook.Sheets[sheetName];\n        \n        // 解析数据\n        const grayScale = parseGrayScaleData(worksheet);\n        const brightnessBlocks = parseBrightnessBlocks(worksheet);\n        \n        resolve({\n          grayScale,\n          brightnessBlocks\n        });\n      } catch (error) {\n        reject(error);\n      }\n    };\n    \n    reader.onerror = () => {\n      reject(new Error('文件读取失败'));\n    };\n    \n    reader.readAsArrayBuffer(file);\n  });\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}